//Defenição dos blocos do jogo
class Blocos {
    constructor(letter, relPath, collidable = false, width = 32, height = 32){
        this.letter = letter;
        this.path = relPath;
        this.collidable = !!collidable;

        this.origWidth = width;
        this.origHeight = height;

        this.displayWidthPx = width; 
        this.displayHeightPx = height;
    }
}
const assetsPath = '../src/sprites/main/blocos/';
const tileTypes = {
    B: new Blocos('B', assetsPath + 'backgroundBLOCK.png', false, 32, 32),
    A: new Blocos('A', assetsPath + 'ar.png', false, 32, 32),
    T: new Blocos('T', assetsPath + 'brick1.png', true, 32, 32),
    C: new Blocos('C', assetsPath + 'bau.png', false, 32, 32),
    M: new Blocos('M', assetsPath + 'moeda.png', false, 32, 32),
    L: new Blocos('L', assetsPath + 'luck.png', true, 32, 32),
    N: new Blocos('N', assetsPath + 'nuvem.png', false, 128, 32),
    // Power-ups
    'P-BOLT': new Blocos('P-BOLT', '../src/sprites/main/powers/bolt.png', false, 32, 32),
    'P-SHIELD': new Blocos('P-SHIELD', '../src/sprites/main/powers/shield.png', false, 32, 32),
    'P-HEART': new Blocos('P-HEART', '../src/sprites/main/powers/hp.png', false, 32, 32),
    'P-SCORE': new Blocos('P-SCORE', '../src/sprites/main/powers/score.png', false, 32, 32)
}

const LarguraMapa = 200; //largura da matriz em blocos
const AlturaMapa = 19; //altura da matriz em blocos


//Mapa 1
//1 layer - blocos de fundo
//2 layer - blocos do jogo
//3 layer - jogador

let mapa1_layer1 = [];
for (let y = 0; y < AlturaMapa; y++) {
    mapa1_layer1[y] = new Array(LarguraMapa).fill('B');
}


const mapa1_layer2 = [
    ['N','','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','','','','','N','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','L','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','M','M','M','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','L','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','T','T','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','M','M','','T','T','T','T','T','T','','','','','','','','','','M','M','M','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','M','M','M','','','','','','','','','','','','','','M','M','','M','M','','','','','','','','','','','','','','','','','','','','','','','','','','M','M','','','','','','','','','','M','M','','','','','','','','','','','','','','T','T','T','','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','T','T','T','T','T','M','M','M','M','M','','','','','','','','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','','','','','','','T','T','T','T','T','T','T','','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','','T','T','T','T','T','T','T','','','','','T','T','T','T','T','T','T','','','','','','T','T','T','T','T','','','','','','','','','','L','L','L','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','M','M','','','','','','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','M','M','M','M','M','','','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','T','T','T','T','T','T','T','T','T','T','T','','','','','','T','T','T','T','T','T','T','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','T','T','M','M','T','T','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','T','T','T','T','T','T','','','','','','','','L','L','','','','','','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','L','L','L',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','','','T','T','T','T','','','T','T','T','T','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','A','','','A','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','','','M','M','M','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','','','','','','','','','T','T','T','T','T','T','','','T','T','T','T','T','T','','','','','','','','','','','','','','','','','M','M','M','','','T','T','','','','','','','','','','','','','','','','','','','','','','','','','','','T','T','','M','M','M','','','','T','T','','','A','','','','','','','','','','','','','','','','','','A','','','M','','','T','T','','M','M','','','','','T','T','','','','','','','','','','','','','','','','','','','A','','','','','','T','T','T','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','','','','','M','M','M','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','L','','','','','','','L','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','M','M','','','','','','L','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','',''],
    ['','','','','','','','','','','','','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','','','','','','L','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','M','M','','','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','','','','','','','','','','','L','M','M','L','M','M','L','','','','','','','','','','','','','','','','','','','','L','','','','','A','M','M','M','M','M','M','M','M','M','M','M','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','',''],
    ['','','','','','','','','','','T','T','T','T','T','T','T','T','T','','','','M','M','','A','A','','M','M','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','A','','','','','','','','M','M','M','M','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','','','','','','A','','','M','M','','','A','','','','','','','','','','','','','','','','','','A','','M','M','M','M','M','','A','','','','','','','','','','','A','M','M','M','M','M','M','M','M','M','M','M','T','T','T','T','T','T','T','M','M','M','M','M','M','M','M','','','','','T','',''],
    ['','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','','','','','','','','','','','','','','','','','','','','','','','','','','','M','M','','','','','','','','','','','','','','','','','','','','','','','A','','M','M','M','M','','A','','','','','','','','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','M','M','M','M','M','M','M','M','','','','C','T',''],
    ['T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T'],
    ['T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T','T'],
];

let mapa1_layer3 = [];
for (let y = 0; y < AlturaMapa; y++) {
    mapa1_layer3[y] = new Array(LarguraMapa).fill('');
}

//Defenir ponto de spawn do jogador
const spawnCol = 0;
const spawnRowFromBottom = 3; 
const spawnY = AlturaMapa - spawnRowFromBottom;
if (mapa1_layer3[spawnY]) mapa1_layer3[spawnY][spawnCol] = 'P';

function LoadMap(layer1, layer2, layer3) { //Carregar o mapa
    DrawLayer(layer1, document.getElementById("layer1"));
    DrawLayer(layer2, document.getElementById("layer2"));
    DrawLayer(layer3, document.getElementById("layer3"));

    // Re-inicializar sistema de nuvens para recolher os novos elementos
    if (typeof InitNuvens === 'function') {
        InitNuvens();
    }
}

function DrawLayer(matriz, DivCamada) { //Desenhar cada layer do mapa
    DivCamada.innerHTML = "";
    
    const layerName = DivCamada.id; // layer1, layer2, layer3

    for (let y = 0; y < AlturaMapa; y++) { //percorrer as linhas
        for (let x = 0; x < LarguraMapa; x++) { //percorrer as colunas

            // proteger contra linhas mais curtas que LarguraMapa
            const row = matriz[y] || [];
            const letter = (x < row.length) ? row[x] : '';

            //se o tile for null entao e criada uma div vazia
            if (!letter) {
                const TileVazio = document.createElement("div");
                TileVazio.id = `tile_${x}_${y}_${layerName}`; //id unico para tiles vazios
                TileVazio.style.width = "32px";
                TileVazio.style.height = "32px";
                DivCamada.appendChild(TileVazio);
                continue;
            }

            const tileType = tileTypes[letter];
            if (!tileType) {
                //se o tile nao tiver na classe de tiles entao deve se tratar como vazio
                const TileVazio = document.createElement("div");
                TileVazio.id = `tile_${x}_${y}_${layerName}`;
                TileVazio.style.width = "32px";
                TileVazio.style.height = "32px";
                DivCamada.appendChild(TileVazio);
                continue;
            }

            const img = document.createElement("img");
            img.id = `tile_${x}_${y}_${layerName}`; //id unico para cada tile
            img.src = tileType.path;
            img.width = tileType.displayWidthPx;
            img.height = tileType.displayHeightPx;

            // nuvens para parallax 
            if (y < 3 && letter === 'N') {
                img.setAttribute('data-cloud', 'true');
            }

            // calcular colSpan e limitar a quantidade de colunas restantes
            let colSpan = Math.max(1, Math.floor(tileType.displayWidthPx / 32));
            const remaining = LarguraMapa - x;
            if (colSpan > remaining) colSpan = remaining; //evita overflow quando tem nuvem no fim

            img.style.gridColumn = `span ${colSpan}`;

            DivCamada.appendChild(img);
            
            x += colSpan - 1; 
            /*O x avança para a proxima posição na matriz a seguir ao tile;
            Se tivermos um tile com largura maior que 32, o x vai para a proxima posiçao a seguir ao tile
            E para as nuvens pq tem 128 de largura*/
        }
    }


    if (DivCamada && DivCamada.id === 'layer2' && typeof InitNuvens === 'function') { // Re-inicializar sistema de nuvens
        InitNuvens();
    }
}

//Procurar o spawn point do jogador ("P")
function findPlayerSpawn(layer) {
    for (let y = 0; y < AlturaMapa; y++) {
        for (let x = 0; x < LarguraMapa; x++) {
            if (layer[y][x] === 'P') {
                layer[y][x] = ''; //limpar o P da matriz
                return { x, y };
            }
        }
    }

    //fallback se nao houver P
    return { x: 0, y: 16 };
}

// renderar apenas um tile especifico do mapa
function UpdateTile(x, y, layerName, matrix) {
    const tileId = `tile_${x}_${y}_${layerName}`;
    const tileElement = document.getElementById(tileId);
    
    if (!tileElement) return;
    
    // indices fora dos limites
    if (y < 0 || y >= AlturaMapa || x < 0 || x >= matrix[y].length) return;
    
    const letter = matrix[y][x];
    const tileType = tileTypes[letter];
    
    if (!letter || !tileType) {
        // se tile for vazio entao tira-se a imagem
        tileElement.classList.add('tile-empty');
        tileElement.style.backgroundImage = 'none';
        if (tileElement.tagName === 'IMG') {
            tileElement.src = '';
        }
    } else {
        // atualizar a imagem do tile
        tileElement.classList.remove('tile-empty');
        if (tileElement.tagName === 'IMG') {
            tileElement.src = tileType.path;
        } else {
            tileElement.style.backgroundImage = `url('${tileType.path}')`;
        }
    }
}

function SeBlocosCoincidem(ax, ay, aw, ah, bx, by, bw, bh) { //colisoes atraves de retangulos
    //ver se nao ha espaço entre os retangulos
    return (
        ax < bx + bw && //se o lado esquerdo de A for menor que o lado direito de B
        ax + aw > bx && //se o lado direito de A for maior que o lado esquerdo de B
        ay < by + bh && //se o lado superior de A for menor que o lado inferior de B
        ay + ah > by //se o lado inferior de A for maior que o lado superior de B
    );
}

